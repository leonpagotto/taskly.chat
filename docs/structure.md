# Repository Task & Board Structure

This document describes how the task governance, backlog stories, and board artifacts are organized and persisted in GitHub. It is intended for integration consumers (e.g. external tooling, dashboards, or synchronization services) that need a stable contract for reading task data and board state.

## Overview
The repository stores all planning and execution tasks as Markdown files. They are partitioned into:
- Story Backlogs: `docs/taskly-chat/stories/<NN>-<story-slug>/Backlog/*.md`
- Global Pipeline: `tasks/<status>/*.md` where `<status>` is one of `todo | in-progress | review | done`

Governance scripts generate derived artifacts:
- Manifest: `tasks.yaml` + `tasks.json` – canonical indexed listing of all tasks.
- Metrics: `metrics/tasks-metrics.json` – time-in-status & aging metrics.
- Board Data: `tasks-board.json` – enriched board view merging manifest + metrics.

## Directory Layout
```
/ (repo root)
  tasks.yaml                # YAML manifest (source of truth index)
  tasks.json                # JSON manifest mirror
  tasks-board.json          # Aggregated board snapshot (lightweight UI feed)
  metrics/
    tasks-metrics.json      # Per-task timing metrics
  tasks/
    todo/                   # Pipeline tasks in TODO
    in-progress/            # Pipeline tasks currently being executed
    review/                 # Pipeline tasks under review (optional)
    done/                   # Completed pipeline tasks (retained for history)
  docs/
    TASKS-GUIDELINES.md     # Governance & naming rules
    structure.md            # (This file) Integration-facing structure contract
    taskly-chat/
      stories/
        <NN>-<story-slug>/
          story.md          # Narrative / context for the story
          Backlog/          # Story-scoped backlog tasks
            <ID>-<slug>.md  # Individual backlog task files
```

## File Naming Conventions
- Story folder: two-digit order prefix + kebab slug (e.g. `07-share-project-with-collaborator`).
- Task file: `<ID>-<short-kebab-title>.md` (transitional tasks without slug will be migrated; post-migration the slug is mandatory).
- IDs are globally unique (e.g. `IMP-101`, `DEV-013`).

## Task File Schema (Markdown Front Matter Region)
Each task file begins with a header section (not strict YAML, but line-based key/value) containing at least:
```
# Task: <ID>
Status: <Backlog|Todo|In-Progress|Review|Done>
Story: <story-folder-name or omitted for pipeline tasks>
Created: YYYY-MM-DD
Type: <type>
Related: <comma-separated IDs or blank>
Owner: <optional>
```
Followed by content sections: Summary, Acceptance Criteria, Implementation Notes, Progress Log.

## Provenance & Progress Log
Status transitions (when implemented) appear as log lines in the `## Progress Log` section. Supported patterns:
```
<ISO8601>Z promoted backlog→todo
<ISO8601>Z status→in-progress
<ISO8601>Z status→review
<ISO8601>Z status→done
<ISO8601>Z EVENT:status-change from=<prev> to=<next>
```
The metrics generator consumes both legacy (`promoted` / `status→`) and the standardized `EVENT:status-change` format.

## Generated Artifacts
### tasks.yaml / tasks.json
Fields per entry:
- `id`: Canonical ID (slug appended for backlog entries in manifest to ensure uniqueness where needed).
- `title`: Raw ID without slug (useful for UI label).
- `status`: One of `backlog | todo | in-progress | review | done`.
- `story`: Story folder key (omitted or absent for pipeline tasks).
- `file`: Relative path to the source Markdown file.

### metrics/tasks-metrics.json
Structure:
```
{
  generated: <ISO timestamp>,
  metrics: [
    {
      id,               // matches manifest id (filename stem)
      file,             // relative path
      durations: { backlog, todo, 'in-progress', review, done }, // seconds spent
      openIntervalSeconds,           // seconds since last status change (if not done)
      currentStatusDurationSeconds,  // alias for open interval (for convenience)
      currentStatus                  // inferred last status or 'backlog'
    }, ...
  ]
}
```
If a task has no explicit status change events, time accrues under `backlog` from its Created date.

### tasks-board.json
Merges manifest entries with metric enrichment. Intended as a single file ingestion point for front-end boards or external dashboards. Each task object includes:
- All manifest fields.
- Metrics overlay: `durations`, `currentStatus`, `currentStatusDurationSeconds`.

## Integration Guidelines
- Prefer `tasks-board.json` for lightweight board rendering.
- Fall back to `tasks.yaml` / `tasks.json` if deeper metadata or future fields are needed.
- Use `metrics/tasks-metrics.json` for analytics pipelines (aging, flow efficiency, SLA alerts).
- Treat Markdown task files as the *source of truth*; all other artifacts are reproducible.

## Refresh Cycle
Artifacts are regenerated by scripts (invoked manually or via CI) in this order:
1. `node scripts/validate-tasks.mjs`
2. `node scripts/sync-tasks-manifest.mjs`
3. `node scripts/generate-task-metrics.mjs`
4. `node scripts/generate-board-data.mjs`

## Migration Notes
- Slug addition is in progress for legacy filenames missing the `<slug>` segment; once complete the validator will elevate missing slugs from warning to error.
- Metrics currently show all time in `backlog` until status promotion events are appended to Progress Logs.

## Contract Stability
- Filenames and directory topology above are considered stable integration boundaries.
- New fields may be added to JSON artifacts; existing fields will not be repurposed without a deprecation note in this `structure.md`.

## Consumption Examples
Fetch board (curl example):
```
curl -s https://raw.githubusercontent.com/<org>/<repo>/main/tasks-board.json | jq '.tasks[0]'
```
Pull a specific task file:
```
curl -s https://raw.githubusercontent.com/<org>/<repo>/main/docs/taskly-chat/stories/00-lobe-chat-framework-integration/Backlog/IMP-101-minimal-lobe-mount.md
```

## Future Enhancements
- Introduce `archived/` directory for completed aged tasks (with retention policy).
- Add cumulative flow snapshot generator.
- Emit hash digests for task content integrity in manifest.
- Provide GraphQL endpoint mapping (out of scope for current repository only model).
